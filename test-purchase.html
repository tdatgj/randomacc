<!DOCTYPE html>
<html>
<head>
    <title>Test Purchase</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
        button { padding: 15px 30px; margin: 10px; background: #ff6b35; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #ff8c42; }
        .result { margin: 20px 0; padding: 15px; background: #16213e; border-radius: 5px; white-space: pre-wrap; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
    </style>
</head>
<body>
    <h1>üõí Test Purchase Function</h1>
    
    <button onclick="testPurchase()">Test Purchase 9k Account</button>
    <button onclick="checkData()">Check Database Data</button>
    <button onclick="clearTest()">Clear Test Data</button>
    
    <div id="result" class="result">Click a button to start...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore-compat.js"></script>
    <script src="encryption.js"></script>
    
    <script>
        let db;
        
        function log(message) {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            result.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        async function initFirebase() {
            if (typeof firebase === 'undefined') {
                log('‚è≥ Waiting for Firebase...');
                await new Promise(resolve => setTimeout(resolve, 500));
                return initFirebase();
            }
            
            const firebaseConfig = {
                apiKey: "AIzaSyAiD-pBWfSwvmIsWmHI9cCp3wn93CqshQE",
                authDomain: "randomacc-96218.firebaseapp.com",
                projectId: "randomacc-96218",
                storageBucket: "randomacc-96218.firebasestorage.app",
                messagingSenderId: "113176272821",
                appId: "1:113176272821:web:1eabdc70e688db379203fc",
                measurementId: "G-TPQH4G05C2"
            };
            
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            log('‚úÖ Firebase connected');
        }
        
        async function checkData() {
            try {
                await initFirebase();
                log('üîç Checking database data...');
                
                // Check users
                const usersSnapshot = await db.collection('users').get();
                log(`üë• Users: ${usersSnapshot.size}`);
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    log(`  - ${data.username}: ${data.balance} VNƒê`);
                });
                
                // Check game accounts
                const accountsSnapshot = await db.collection('gameAccounts').get();
                log(`üéÆ Game Accounts: ${accountsSnapshot.size}`);
                accountsSnapshot.forEach(doc => {
                    const data = doc.data();
                    log(`  - ${data.name}: ${data.price} VNƒê (${data.status})`);
                });
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function testPurchase() {
            try {
                await initFirebase();
                log('üõí Testing purchase...');
                
                // Get test user
                const userSnapshot = await db.collection('users').where('username', '==', 'testuser').get();
                if (userSnapshot.empty) {
                    throw new Error('Test user not found');
                }
                
                const userDoc = userSnapshot.docs[0];
                const userData = userDoc.data();
                log(`üë§ User: ${userData.username}, Balance: ${userData.balance} VNƒê`);
                
                // Get available 9k account
                const accountSnapshot = await db.collection('gameAccounts')
                    .where('name', '==', '9k')
                    .where('status', '==', 'available')
                    .limit(1)
                    .get();
                
                if (accountSnapshot.empty) {
                    throw new Error('No available 9k accounts');
                }
                
                const accountDoc = accountSnapshot.docs[0];
                const accountData = accountDoc.data();
                log(`üéÆ Account: ${accountData.name}, Price: ${accountData.price} VNƒê`);
                
                // Simulate purchase
                const price = accountData.price;
                const newBalance = userData.balance - price;
                
                if (newBalance < 0) {
                    throw new Error('Insufficient balance');
                }
                
                // Decrypt credentials
                const decryptedUsername = decrypt(accountData.username, 13);
                const decryptedPassword = decrypt(accountData.password, 13);
                log(`üîë Credentials: ${decryptedUsername} / ${decryptedPassword}`);
                
                // Create transaction
                const transaction = {
                    type: 'purchase',
                    amount: -price,
                    description: `Mua ${accountData.name}`,
                    timestamp: new Date().toISOString(),
                    accountId: accountDoc.id,
                    username: decryptedUsername,
                    password: decryptedPassword
                };
                
                // Update user
                const updatedTransactions = [...(userData.transactions || []), transaction];
                await db.collection('users').doc(userDoc.id).update({
                    balance: newBalance,
                    transactions: updatedTransactions
                });
                
                // Mark account as sold
                await db.collection('gameAccounts').doc(accountDoc.id).update({
                    status: 'sold',
                    soldTo: userData.username,
                    soldAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                log(`‚úÖ Purchase successful! New balance: ${newBalance} VNƒê`);
                log(`‚úÖ Account sold to: ${userData.username}`);
                
            } catch (error) {
                log(`‚ùå Purchase Error: ${error.message}`);
                console.error(error);
            }
        }
        
        async function clearTest() {
            try {
                await initFirebase();
                log('üóëÔ∏è Clearing test data...');
                
                // Reset test user balance
                const userSnapshot = await db.collection('users').where('username', '==', 'testuser').get();
                if (!userSnapshot.empty) {
                    await db.collection('users').doc(userSnapshot.docs[0].id).update({
                        balance: 100000,
                        transactions: [{
                            type: 'deposit',
                            amount: 100000,
                            description: 'Reset balance',
                            timestamp: new Date().toISOString(),
                            approved: true
                        }]
                    });
                    log('‚úÖ Reset test user balance');
                }
                
                // Reset all accounts to available
                const accountsSnapshot = await db.collection('gameAccounts').get();
                const batch = db.batch();
                accountsSnapshot.docs.forEach(doc => {
                    batch.update(doc.ref, {
                        status: 'available',
                        soldTo: firebase.firestore.FieldValue.delete(),
                        soldAt: firebase.firestore.FieldValue.delete()
                    });
                });
                await batch.commit();
                log('‚úÖ Reset all accounts to available');
                
            } catch (error) {
                log(`‚ùå Clear Error: ${error.message}`);
            }
        }
        
        // Auto-init
        window.addEventListener('load', () => {
            initFirebase();
        });
    </script>
</body>
</html>
